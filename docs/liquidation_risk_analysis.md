# 强平风险分析功能

## 概述

在RiskManagementNode类中实现了`analyze_liquidation_risk`方法，用于基于实际价格和真实杠杆进行强平风险分析。该功能可以准确计算强平价格、风险距离、强平概率等关键指标，为实时风险监控提供可靠数据支持。

## 功能特性

### 1. 强平价格计算 (liquidation_price)
- 基于不同杠杆倍数使用相应的维持保证金率
- 考虑手续费影响（0.1%缓冲）
- 针对多头仓位的精确计算公式

### 2. 强平距离计算 (liquidation_distance)
- 计算当前价格与强平价格的距离百分比
- 正数表示安全距离，负数表示已触发强平

### 3. 强平概率估算 (liquidation_probability)
- 基于历史波动率和正态分布模型
- 考虑波动率聚集效应
- 24小时内强平概率预测

### 4. 安全杠杆门槛 (safe_leverage_threshold)
- 根据市场波动率动态调整
- 考虑仓位规模和趋势因子
- 避免强平风险的最大建议杠杆

### 5. 预计强平时间 (time_to_liquidation)
- 基于几何布朗运动模型
- 结合波动率趋势预测
- 以小时为单位的时间估算

## 输出格式

```json
"liquidation_analysis": {
  "liquidation_price": 39240.0000,      // 强平价格(USD)
  "liquidation_distance": 0.0190,       // 距强平距离(1.9%)
  "liquidation_probability": 0.3194,    // 强平概率(31.94%)
  "safe_leverage_threshold": 8,         // 安全杠杆门槛(8x)
  "time_to_liquidation": 1.0            // 预计强平时间(1小时)
}
```

## 技术实现

### 核心算法

1. **强平价格计算**：
   ```
   维持保证金率 = f(杠杆倍数)
   强平价格 = 开仓价格 × (1 - (1/杠杆 - 维持保证金率 - 手续费缓冲))
   ```

2. **强平概率计算**：
   ```
   Z分数 = (当前价格 - 强平价格) / (当前价格 × 日波动率)
   强平概率 = 标准正态分布CDF(-Z分数)
   ```

3. **安全杠杆计算**：
   ```
   基础杠杆 = f(波动率百分位数)
   安全杠杆 = 基础杠杆 × 趋势因子 × 仓位因子
   ```

### 集成方式

强平风险分析已完全集成到RiskManagementNode的主调用流程中：

1. 杠杆分析 → 保证金管理 → 动态风险指标 → **强平风险分析**
2. 所有分析结果统一输出到`analyst_signals["risk_management_agent"]`
3. 支持多个ticker并发分析

## 使用场景

### 实时风险监控
- 持续监控强平距离，当距离小于5%时发出警报
- 跟踪强平概率变化，及时调整仓位
- 预测强平时间，提前采取风险控制措施

### 动态杠杆调整
- 根据安全杠杆门槛调整实际使用的杠杆倍数
- 在高波动率期间自动降低杠杆
- 在低风险环境下适度提高资金效率

### 风险预警系统
- 强平概率 > 30%：高风险警告
- 强平距离 < 5%：紧急风险警告
- 预计强平时间 < 24小时：即时风险处理

## 配置参数

### 维持保证金率配置
- 50x杠杆：2%维持保证金率
- 20x杠杆：5%维持保证金率
- 10x杠杆：8%维持保证金率
- 5x杠杆：15%维持保证金率
- 低杠杆：20%维持保证金率

### 安全杠杆分级
- 波动率≥80%：最大3x杠杆
- 波动率60-80%：最大5x杠杆
- 波动率20-60%：最大10x杠杆
- 波动率≤20%：最大20x杠杆

## 依赖要求

- **scipy**: 用于正态分布概率计算
- **pandas**: 历史数据处理
- **numpy**: 数值计算

已添加到项目依赖：`scipy>=1.13.0`

## 注意事项

1. **开仓价格近似**：当前实现使用当前价格作为开仓价格的近似值，实际应用中应使用真实的开仓价格。

2. **多空仓位**：当前实现专注于多头仓位，空头仓位的强平计算逻辑不同。

3. **交易所差异**：不同交易所的维持保证金率和强平机制可能有差异，需要根据实际情况调整。

4. **模型假设**：强平概率计算基于正态分布假设，极端市场条件下可能存在偏差。

## 后续优化方向

1. 支持空头仓位的强平风险计算
2. 接入真实开仓价格数据
3. 考虑资金费率对强平价格的影响
4. 增加蒙特卡洛模拟提高概率计算精度
5. 支持组合仓位的整体强平风险分析